<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Employee Leave System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #fbf9ff;
      --card: #ffffff;
      --muted: #7b7b88;
      --accent1: #ffd6e7;
      --accent2: #e6f6ff;
      --accent3: #fff1d6;
      --accent4: #e9fbe9;
      --primary: #6f46ff;
      --shadow: 0 8px 28px rgba(40,40,55,0.08);
      --radius: 14px;
    }

    /* Dark mode theme */
    body.dark {
      --bg: #121212;
      --card: #1e1e1e;
      --muted: #cccccc;
      --primary: #bb86fc;
      color: #fff;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      font-family: Inter, system-ui;
      color: #222;
    }

    .wrap {
      max-width: 1400px;
      margin: auto;
      padding: 20px;
    }

    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 0;
    }

    h1 { font-size:26px; margin:0; }

    /* Card Style */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding:20px;
      box-shadow: var(--shadow);
      margin-bottom:20px;
    }

    .btn {
      padding:10px 16px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:600;
      background: var(--primary);
      color:white;
      transition:0.2s;
    }
    .btn:hover { transform: translateY(-2px); }

    .btn.secondary {
      background: transparent;
      border: 1px solid #9993;
      color: #333;
    }

    body.dark .btn.secondary { color:#fff; border-color:#fff4; }

    input, select {
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid #ddd;
      margin-bottom:10px;
      font-size:14px;
    }

    body.dark input, body.dark select {
      background:#222;
      color:white;
      border-color:#444;
    }

    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    .grid-4 { display:grid; grid-template-columns:repeat(4,1fr); gap:20px; }

    @media(max-width:900px){
      .grid-2, .grid-4 { grid-template-columns:1fr; }
    }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
    }
    th,td {
      padding:10px;
      border-bottom:1px solid #eee;
    }

    body.dark th, body.dark td { border-color:#444; }

    .msg { padding:10px; border-radius:10px; display:none; margin-top:10px; }
    .ok { background:#e4ffe4; color:#155b15; }
    .err { background:#ffe5e5; color:#8a1f1f; }

    body.dark .ok { background:#093; color:#fff; }
    body.dark .err { background:#500; color:#fff; }
  </style>
</head>

<body>
<div class="wrap">

  <header>
    <h1>Employee Leave System</h1>
    <button id="toggleDark" class="btn secondary">ðŸŒ™ Dark Mode</button>
  </header>

  <!-- DASHBOARD SUMMARY -->
  <div class="grid-4">
    <div class="card"><h2 id="dashEmployees">0</h2><p>Total Employees</p></div>
    <div class="card"><h2 id="dashLeaves">0</h2><p>Total Leave Requests</p></div>
    <div class="card"><h2 id="dashApproved">0</h2><p>Approved</p></div>
    <div class="card"><h2 id="dashPending">0</h2><p>Pending</p></div>
  </div>

  <div class="grid-2">

    <!-- LEFT SIDE -->
    <div>
      <div class="card">
        <h3>Add Employee</h3>
        <input id="emp_name" type="text" placeholder="Employee Name">
        <input id="emp_balance" type="number" value="20">
        <button id="btnAdd" class="btn">Add Employee</button>
        <div id="addMsg" class="msg"></div>
      </div>

      <div class="card">
        <h3>Employees</h3>
        <input id="searchEmp" type="text" placeholder="Search employee...">
        <div id="employeesArea"><em>Loading...</em></div>
      </div>
    </div>

    <!-- RIGHT SIDE -->
    <div>
      <div class="card">
        <h3>Apply Leave</h3>
        <input id="apply_emp" type="number" placeholder="Employee ID">
        <input id="apply_type" type="text" placeholder="Leave Type" value="Casual">
        <input id="apply_start" type="date">
        <input id="apply_end" type="date">
        <button id="btnApply" class="btn">Apply</button>
        <div id="applyMsg" class="msg"></div>
      </div>

      <div class="card">
        <h3>Leaves</h3>
        <select id="filterLeave">
          <option value="">All</option>
          <option>Pending</option>
          <option>Approved</option>
          <option>Rejected</option>
        </select>
        <div id="leavesArea"><em>Loading...</em></div>
      </div>

      <div class="card">
        <h3>Monthly Summary</h3>
        <input id="sum_emp" type="number" placeholder="Employee ID" value="1">
        <input id="sum_month" type="number" value="12" min="1" max="12">
        <input id="sum_year" type="number" value="2025">
        <button id="btnSummary" class="btn">Show Summary</button>
        <div id="summaryArea"></div>
        <canvas id="leaveChart" height="200"></canvas>
      </div>
    </div>

  </div>

</div>

<script>
const API = "https://employee-leave-system-x9i9.onrender.com";

function showMsg(el, text, ok=true){
  el.style.display = "block";
  el.textContent = text;
  el.className = "msg " + (ok ? "ok" : "err");
  setTimeout(() => el.style.display="none", 3000);
}

async function fetchJSON(url, opts={}){
  const r = await fetch(url, opts);
  if(!r.ok){
    let t = await r.text();
    throw new Error(t);
  }
  return r.json();
}

/* DARK MODE */
document.getElementById("toggleDark").addEventListener("click", () => {
  document.body.classList.toggle("dark");
});

/* LOAD EMPLOYEES */
async function loadEmployees(){
  const area = document.getElementById("employeesArea");
  const list = await fetchJSON(API + "/employees");
  if (!list.length) return area.innerHTML = "<em>No employees</em>";

  let html = `<table><thead><tr>
    <th>ID</th><th>Name</th><th>Balance</th></tr></thead><tbody>`;
  for (const e of list)
    html += `<tr><td>${e.employee_id}</td><td>${e.name}</td><td>${e.total_leave_balance}</td></tr>`;
  html += `</tbody></table>`;
  area.innerHTML = html;

  // SEARCH
  document.getElementById("searchEmp").addEventListener("input", e => {
    const val = e.target.value.toLowerCase();
    document.querySelectorAll("#employeesArea tbody tr").forEach(row=>{
      row.style.display = row.textContent.toLowerCase().includes(val) ? "" : "none";
    });
  });
}

/* LOAD LEAVES */
async function loadLeaves(){
  const area = document.getElementById("leavesArea");
  const list = await fetchJSON(API + "/leave");

  let html = `<table><thead><tr>
  <th>ID</th><th>Emp</th><th>Type</th><th>Start</th>
  <th>End</th><th>Days</th><th>Status</th></tr></thead><tbody>`;

  for (const r of list){
    html += `<tr>
    <td>${r.request_id}</td>
    <td>${r.employee_id}</td>
    <td>${r.leave_type}</td>
    <td>${r.start_date}</td>
    <td>${r.end_date}</td>
    <td>${r.days}</td>
    <td>${r.status}</td></tr>`;
  }

  html += `</tbody></table>`;
  area.innerHTML = html;

  // Filter
  document.getElementById("filterLeave").addEventListener("change", e => {
    const value = e.target.value;
    document.querySelectorAll("#leavesArea tbody tr").forEach(row=>{
      const status = row.children[6].textContent;
      row.style.display = (value === "" || status === value) ? "" : "none";
    });
  });
}

/* ADD EMPLOYEE */
document.getElementById("btnAdd").addEventListener("click", async () => {
  const name = document.getElementById("emp_name").value;
  const bal = document.getElementById("emp_balance").value;
  const box = document.getElementById("addMsg");
  if (!name) return showMsg(box, "Name required", false);

  try {
    await fetchJSON(API+"/employees", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ name, total_leave_balance:Number(bal) })
    });
    showMsg(box, "Employee added", true);
    loadEmployees();
    updateDashboard();
  } catch(e){ showMsg(box, e.message, false); }
});

/* APPLY LEAVE */
document.getElementById("btnApply").addEventListener("click", async () => {
  const emp = Number(document.getElementById("apply_emp").value);
  const type = document.getElementById("apply_type").value;
  const start = document.getElementById("apply_start").value;
  const end = document.getElementById("apply_end").value;
  const box = document.getElementById("applyMsg");
  if (!emp || !start || !end) return showMsg(box,"Fill all fields",false);

  try {
    await fetchJSON(API+"/leave",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ employee_id:emp, leave_type:type, start_date:start, end_date:end })
    });
    showMsg(box, "Leave applied", true);
    loadLeaves();
    updateDashboard();
  } catch(e){ showMsg(box,e.message,false); }
});

/* SUMMARY + CHART */
let chartInstance = null;

document.getElementById("btnSummary").addEventListener("click", async ()=>{
  const emp = document.getElementById("sum_emp").value;
  const m = document.getElementById("sum_month").value;
  const y = document.getElementById("sum_year").value;
  const area = document.getElementById("summaryArea");

  const data = await fetchJSON(`${API}/summary?employee_id=${emp}&month=${m}&year=${y}`);

  if(!data.length){ area.innerHTML="<em>No records</em>"; return; }

  let html = "<table><thead><tr><th>ID</th><th>Type</th><th>Days</th><th>Status</th></tr></thead><tbody>";
  for(const r of data)
    html += `<tr><td>${r.request_id}</td><td>${r.leave_type}</td><td>${r.days}</td><td>${r.status}</td></tr>`;
  html += "</tbody></table>";
  area.innerHTML = html;

  // Chart
  const ctx = document.getElementById('leaveChart').getContext("2d");
  const labels = data.map(r => r.leave_type);
  const values = data.map(r => r.days);

  if(chartInstance) chartInstance.destroy();

  chartInstance = new Chart(ctx,{
    type:"bar",
    data:{
      labels,
      datasets:[{
        label:"Leave Days",
        data:values
      }]
    }
  });
});

/* DASHBOARD CARDS */
async function updateDashboard(){
  const emps = await fetchJSON(API+"/employees");
  const leaves = await fetchJSON(API+"/leave");

  document.getElementById("dashEmployees").textContent = emps.length;
  document.getElementById("dashLeaves").textContent = leaves.length;

  document.getElementById("dashApproved").textContent =
    leaves.filter(l => l.status==="Approved").length;

  document.getElementById("dashPending").textContent =
    leaves.filter(l => l.status==="Pending").length;
}

/* INITIAL LOAD */
loadEmployees();
loadLeaves();
updateDashboard();
</script>

</body>
</html>
